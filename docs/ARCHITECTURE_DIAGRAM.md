# Architecture Diagrams

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Users / Clients                                │
│                   (Web Browser, Mobile Apps, API Clients)                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ HTTPS
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CDN (CloudFront)                                 │
│                     (Static assets, Edge caching)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Application Load Balancer (ALB)                        │
│          SSL Termination, Health Checks, Routing, Auto-scaling              │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                       ┌──────────────┴──────────────┐
                       │                             │
                       ▼                             ▼
        ┌──────────────────────────┐  ┌──────────────────────────┐
        │  FastAPI Instance 1      │  │  FastAPI Instance N      │
        │  ┌────────────────────┐  │  │  ┌────────────────────┐  │
        │  │ Forecast Service   │  │  │  │ Forecast Service   │  │
        │  │ Data Service       │  │  │  │ Data Service       │  │
        │  │ ML Model Wrapper   │  │  │  │ ML Model Wrapper   │  │
        │  └────────────────────┘  │  │  └────────────────────┘  │
        └──────────────────────────┘  └──────────────────────────┘
                       │                             │
                       └──────────────┬──────────────┘
                                      │
        ┌─────────────────────────────┼─────────────────────────────┐
        │                             │                             │
        ▼                             ▼                             ▼
┌──────────────┐           ┌──────────────────┐          ┌─────────────────┐
│    Redis     │           │   ML Model       │          │   PostgreSQL    │
│   Cluster    │           │   Service        │          │    Primary      │
│              │           │                  │          │                 │
│ - Forecasts  │           │  ┌────────────┐  │          │  - Sales Data   │
│ - Sessions   │           │  │  XGBoost   │  │          │  - Products     │
│ - Rate Limit │           │  │  Prophet   │  │          │  - Categories   │
│              │           │  │  Ensemble  │  │          │  - Metadata     │
└──────────────┘           │  └────────────┘  │          └─────────────────┘
                           │         │         │                   │
                           │         ▼         │                   │
                           │  ┌────────────┐  │                   │
                           │  │  Feature   │  │                   ▼
                           │  │   Store    │  │          ┌─────────────────┐
                           │  └────────────┘  │          │   PostgreSQL    │
                           └──────────────────┘          │   Read Replica  │
                                      │                  └─────────────────┘
                                      │
                        ┌─────────────┴─────────────┐
                        │                           │
                        ▼                           ▼
            ┌──────────────────┐        ┌──────────────────────┐
            │   Data Lake      │        │   External APIs      │
            │     (S3)         │        │                      │
            │                  │        │  - FRED (Economic)   │
            │ - Raw Data       │        │  - Yahoo Finance     │
            │ - Models         │        │  - Kaggle Datasets   │
            │ - Training Data  │        │  - Weather APIs      │
            │ - Backups        │        │                      │
            └──────────────────┘        └──────────────────────┘
```

## Data Flow - Training Pipeline

```
┌──────────────────────────────────────────────────────────────────┐
│                    Data Ingestion (Daily Job)                    │
└──────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│   Kaggle     │    │     FRED     │    │    Yahoo     │
│   Dataset    │    │   API Data   │    │   Finance    │
│              │    │              │    │              │
│ - Sales      │    │ - GDP        │    │ - S&P 500    │
│ - Products   │    │ - Inflation  │    │ - Trends     │
└──────────────┘    └──────────────┘    └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      ETL Pipeline (Airflow)                      │
│                                                                  │
│  1. Extract: Pull data from sources                             │
│  2. Transform: Clean, normalize, aggregate                      │
│  3. Load: Store in Data Lake and Database                       │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                     Feature Engineering                          │
│                                                                  │
│  - Time features (day, week, month, quarter, holiday)           │
│  - Lag features (sales_lag_7, sales_lag_30)                     │
│  - Rolling stats (mean, std, min, max)                          │
│  - External features (GDP, inflation, indices)                  │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                       Feature Store                              │
│                 (Consistent feature serving)                     │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      Model Training (Weekly)                     │
│                                                                  │
│  ┌────────────────┐                  ┌────────────────┐         │
│  │    XGBoost     │                  │    Prophet     │         │
│  │   Training     │                  │   Training     │         │
│  │                │                  │                │         │
│  │ - 2 years data │                  │ - Time series  │         │
│  │ - Features     │                  │ - Seasonality  │         │
│  │ - Validation   │                  │ - Trends       │         │
│  └────────────────┘                  └────────────────┘         │
│          │                                    │                 │
│          └────────────────┬───────────────────┘                 │
│                           ▼                                     │
│                  ┌─────────────────┐                            │
│                  │ Ensemble Model  │                            │
│                  │  (Weighted Avg) │                            │
│                  └─────────────────┘                            │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│                      Model Evaluation                            │
│                                                                  │
│  - Metrics: MAE, RMSE, R², MAPE                                 │
│  - Validation: Hold-out test set (last 30 days)                 │
│  - Comparison: vs previous model version                        │
└──────────────────────────────────────────────────────────────────┘
                              │
                     Pass threshold?
                              │
                     ┌────────┴────────┐
                     │                 │
                    Yes               No
                     │                 │
                     ▼                 ▼
          ┌─────────────────┐   ┌──────────────┐
          │ Model Registry  │   │    Alert     │
          │  - Version      │   │   (Notify    │
          │  - Metadata     │   │    Team)     │
          │  - Save to S3   │   └──────────────┘
          └─────────────────┘
                     │
                     ▼
          ┌─────────────────┐
          │ Model Deployment│
          │  - Blue/Green   │
          │  - Canary Test  │
          │  - Full Rollout │
          └─────────────────┘
```

## Data Flow - Prediction Request

```
┌──────────────┐
│    Client    │
│  (Browser)   │
└──────────────┘
       │
       │ GET /api/v1/forecast/top-products?time_period=month&category=Electronics
       │
       ▼
┌──────────────────────────────────────────┐
│         Load Balancer                    │
└──────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────┐
│        FastAPI Service                   │
│                                          │
│  1. Request Validation                   │
│  2. Authentication Check                 │
│  3. Rate Limiting                        │
└──────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────┐
│      Forecast Service                    │
│                                          │
│  - Parse request parameters              │
│  - Generate cache key                    │
└──────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────┐
│      Check Redis Cache                   │
│                                          │
│  Key: forecast:Electronics:month:v1      │
└──────────────────────────────────────────┘
       │
       └───────────────┬────────────────┐
                       │                │
                 Cache Hit         Cache Miss
                       │                │
                       │                ▼
                       │     ┌─────────────────────┐
                       │     │  ML Model Service   │
                       │     │                     │
                       │     │  1. Load features   │
                       │     │  2. Run XGBoost     │
                       │     │  3. Run Prophet     │
                       │     │  4. Ensemble result │
                       │     └─────────────────────┘
                       │                │
                       │                ▼
                       │     ┌─────────────────────┐
                       │     │  Post-processing    │
                       │     │                     │
                       │     │  - Sort by sales    │
                       │     │  - Calculate trends │
                       │     │  - Format response  │
                       │     └─────────────────────┘
                       │                │
                       │                ▼
                       │     ┌─────────────────────┐
                       │     │   Update Cache      │
                       │     │   TTL: 1 hour       │
                       │     └─────────────────────┘
                       │                │
                       └────────────────┘
                                │
                                ▼
                     ┌─────────────────────┐
                     │  Return Response    │
                     │                     │
                     │  {                  │
                     │    products: [...], │
                     │    total: 10,       │
                     │    generated_at: .. │
                     │  }                  │
                     └─────────────────────┘
                                │
                                ▼
                     ┌─────────────────────┐
                     │    Client Renders   │
                     │    Dashboard        │
                     └─────────────────────┘
```

## Deployment Architecture (AWS)

```
┌────────────────────────────────────────────────────────────────────┐
│                          Route 53 (DNS)                            │
└────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────────┐
│                      CloudFront (CDN)                              │
│                   - Global edge locations                          │
│                   - DDoS protection                                │
└────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────────┐
│                  WAF (Web Application Firewall)                    │
│                   - SQL injection protection                       │
│                   - XSS protection                                 │
│                   - Rate limiting                                  │
└────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────────┐
│                     VPC (Virtual Private Cloud)                    │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              Public Subnets (Multi-AZ)                       │ │
│  │  ┌──────────────────┐        ┌──────────────────┐           │ │
│  │  │  ALB (AZ-1)      │        │  ALB (AZ-2)      │           │ │
│  │  │  NAT Gateway     │        │  NAT Gateway     │           │ │
│  │  └──────────────────┘        └──────────────────┘           │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                │                                   │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              Private Subnets (Multi-AZ)                      │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐   │ │
│  │  │           Application Tier (Auto Scaling)            │   │ │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐           │   │ │
│  │  │  │ FastAPI  │  │ FastAPI  │  │ FastAPI  │ ...       │   │ │
│  │  │  │  EC2/ECS │  │  EC2/ECS │  │  EC2/ECS │           │   │ │
│  │  │  └──────────┘  └──────────┘  └──────────┘           │   │ │
│  │  └──────────────────────────────────────────────────────┘   │ │
│  │                                                              │ │
│  │  ┌──────────────────────────────────────────────────────┐   │ │
│  │  │                  Data Tier                           │   │ │
│  │  │  ┌──────────────┐         ┌──────────────┐          │   │ │
│  │  │  │ ElastiCache  │         │     RDS      │          │   │ │
│  │  │  │   (Redis)    │         │ (PostgreSQL) │          │   │ │
│  │  │  │   Cluster    │         │  Multi-AZ    │          │   │ │
│  │  │  └──────────────┘         └──────────────┘          │   │ │
│  │  └──────────────────────────────────────────────────────┘   │ │
│  └──────────────────────────────────────────────────────────────┘ │
│                                                                    │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │              ML/Training Subnet                              │ │
│  │  ┌──────────────┐         ┌──────────────┐                  │ │
│  │  │  SageMaker   │         │   EC2 GPU    │                  │ │
│  │  │  Training    │         │   Instances  │                  │ │
│  │  └──────────────┘         └──────────────┘                  │ │
│  └──────────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌────────────────────────────────────────────────────────────────────┐
│                          External Services                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │      S3      │  │  CloudWatch  │  │   Parameter  │            │
│  │   (Models,   │  │   (Logs,     │  │    Store     │            │
│  │    Data)     │  │   Metrics)   │  │   (Secrets)  │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
└────────────────────────────────────────────────────────────────────┘
```

## Monitoring & Observability Stack

```
┌────────────────────────────────────────────────────────────────┐
│                     Application Logs                           │
│           (FastAPI, Model Service, Workers)                    │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                   Log Aggregation                              │
│               (CloudWatch Logs / ELK Stack)                    │
│                                                                │
│  - Structured JSON logs                                        │
│  - Log parsing and indexing                                    │
│  - Full-text search                                            │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                  Metrics Collection                            │
│              (CloudWatch / Prometheus)                         │
│                                                                │
│  - Application: Request rate, latency, errors                  │
│  - Infrastructure: CPU, memory, disk, network                  │
│  - Business: Prediction accuracy, cache hit rate               │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                     Visualization                              │
│                 (Grafana / CloudWatch)                         │
│                                                                │
│  - Real-time dashboards                                        │
│  - Custom charts and graphs                                    │
│  - Business KPIs                                               │
└────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌────────────────────────────────────────────────────────────────┐
│                      Alerting                                  │
│                 (PagerDuty / SNS / Slack)                      │
│                                                                │
│  - Threshold-based alerts                                      │
│  - Anomaly detection                                           │
│  - On-call rotation                                            │
└────────────────────────────────────────────────────────────────┘
```
